<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tom Hummel :: Fidget Toy</title>
    <style>
        #buttons-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }
        .bumper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .counter-button {
            font-size: 16px;
        }
        .counter-button.expiring-soon {
            color: red;
        }
        .counter-button .count {
            display: block;
            font-size: 1.5em;
        }
        .refresh-button,
        .show-json-button {
            font-size: 12px;
        }
        .payload {
            font-size: 0.8em;
            margin-top: 4px;
            border-collapse: collapse;
        }
        .payload td {
            padding: 0 4px;
        }
    </style>
</head>
<body>
    <div id="buttons-container"></div>

<script>
    function updateButtonContent(button, data) {
        const { count, created, updated, _meta } = data;
        const rows = [];

        const formatDate = (timestamp) => {
            if (typeof timestamp !== 'string') return [timestamp, ''];
            const dateOnly = timestamp.split('T')[0];
            return [dateOnly, timestamp];
        };

        if (created?.at !== undefined) {
            const [display, full] = formatDate(created.at);
            rows.push(['Created', display, full]);
        }
        if (updated?.at !== undefined) {
            const [display, full] = formatDate(updated.at);
            rows.push(['Updated', display, full]);
        }
        const expiresAt = _meta?.expires?.at;
        let expiringSoon = false;
        if (expiresAt !== undefined) {
            const [display, full] = formatDate(expiresAt);
            rows.push(['Expires', display, full]);
            const diff = new Date(expiresAt).getTime() - Date.now();
            if (diff < 30 * 24 * 60 * 60 * 1000) {
                expiringSoon = true;
            }
        }

        let tableHTML = '';
        if (rows.length > 0) {
            const rowsHTML = rows
                .map(([label, value, full]) => `<tr><td>${label}</td><td title="${full}">${value}</td></tr>`)
                .join('');
            tableHTML = `<table class="payload"><tbody>${rowsHTML}</tbody></table>`;
        }
        button.innerHTML = `<span class="count">${count}</span>${tableHTML}`;
        button.classList.toggle('expiring-soon', expiringSoon);
    }

    function fetchData(button) {
        const getUrl = button.getAttribute('data-get-url');
        fetch(getUrl, {
            mode: 'cors',
            headers: {
                'Origin': window.location.origin
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateButtonContent(button, data);
        })
        .catch(error => {
            console.error('Error fetching count:', error);
            button.textContent = 'Error';
        });
    }

    function setupBumper(x, y) {
        const getUrl = `https://bumpkit.tphummel.workers.dev/bumper/tph-fidget-${x}-${y}.json`;
        const bumpUrl = `https://bumpkit.tphummel.workers.dev/bumper/tph-fidget-${x}-${y}/bump.json`;

        const wrapper = document.createElement('div');
        wrapper.className = 'bumper';

        const button = document.createElement('button');
        button.className = 'counter-button';
        button.setAttribute('data-get-url', getUrl);
        button.setAttribute('data-bump-url', bumpUrl);
        button.textContent = '0';

        const refresh = document.createElement('button');
        refresh.className = 'refresh-button';
        refresh.textContent = 'Refresh';

        const showJson = document.createElement('button');
        showJson.className = 'show-json-button';
        showJson.textContent = 'Show JSON';

        wrapper.appendChild(button);
        wrapper.appendChild(refresh);
        wrapper.appendChild(showJson);
        document.getElementById('buttons-container').appendChild(wrapper);

        button.addEventListener('click', async () => {
            try {
                const bumpUrl = button.getAttribute('data-bump-url');
                const response = await fetch(bumpUrl, {
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateButtonContent(button, data);
            } catch (error) {
                console.error('Error bumping counter:', error);
                alert(`Failed to bump counter: ${error.message}`);
            }
        });

        refresh.addEventListener('click', () => fetchData(button));

        showJson.addEventListener('click', async () => {
            try {
                const getUrl = button.getAttribute('data-get-url');
                const response = await fetch(getUrl, {
                    mode: 'cors',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                alert(JSON.stringify(data, null, 2));
            } catch (error) {
                console.error('Error fetching JSON:', error);
                alert(`Failed to fetch JSON: ${error.message}`);
            }
        });

        fetchData(button);
    }

    for (let x = 0; x < 4; x++) {
        for (let y = 0; y < 4; y++) {
            setupBumper(x, y);
        }
    }
</script>
</body>
</html>
